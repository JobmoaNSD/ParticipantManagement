<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ParticipantDAO">
    <!-- 기본 쿼리 시작 -->
    <select id="selectAllParticipantBasic" resultType="participant">
        SELECT TOP (#{pageRows})
            구직번호 AS participantJobNo,
            참여자 AS participantPartic,
            성별 AS participantGender,
            최근상담일 AS participantLastCons,
            상담경과일 AS participantAdventCons,
            진행단계 AS participantProgress,
            생년월일 AS participantDob,
            등록일 AS participantRegDate,
            간접고용서비스 AS participantEmploymentService,
            마감 AS participantClose
        FROM (
                 SELECT
                    ROW_NUMBER() OVER (ORDER BY
                        <choose>
                            <!--구직번호가 아니라면-->
                            <when test="column == '구직번호' or column == '참여자' or column == '성별' or
                                        column == '최근상담일' or column == '진행단계' or
                                        column == '생년월일' or column == '등록일' or column == '간접고용서비스'">
                                ${column}
                            </when>
                            <when test="column == '상담경과일'">
                                DATEDIFF(DAY, 최근상담일, GETDATE())
                            </when>
                            <otherwise>
                                구직번호
                            </otherwise>
                        </choose>
                        <choose>
                            <when test="column != '' and order != '' and (order == 'asc' or order == 'desc')">
                                ${order}
                            </when>
                            <otherwise>
                                DESC
                            </otherwise>
                        </choose>
                        ) AS RowNum,
                    구직번호,
                    참여자,
                    성별,
                    CASE
                        WHEN 최근상담일 >= DATEADD(YEAR, -100, GETDATE()) THEN 최근상담일
                        END AS 최근상담일,
                    진행단계,
                    CASE
                        WHEN 생년월일 >= DATEADD(YEAR, -100, GETDATE()) THEN 생년월일
                        END AS 생년월일,
                    CASE
                        WHEN 등록일 >= DATEADD(YEAR, -100, GETDATE()) THEN 등록일
                        END AS 등록일,
                    CASE
                        WHEN 최근상담일 <![CDATA[<>]]> '' AND 마감='false' THEN DATEDIFF(DAY, 최근상담일, GETDATE())
                        END AS 상담경과일,
                    간접고용서비스,
                    마감
                 FROM J_참여자관리
                 WHERE
                     전담자_계정 = #{participantUserid} AND
                     지점 = #{participantBranch}
                 <choose>
                    <when test="participantRegDate != 'All' and participantRegDate != null">
                        AND YEAR(등록일) = #{participantRegDate}
                    </when>
                 </choose>
                 <choose>
                     <when test="endDateOption == 'false'">
                         AND (마감 = 'false' OR 마감 = '')
                     </when>
                     <when test="endDateOption == 'true'">
                         AND 마감 = 'true'
                     </when>
                 </choose>
                 <choose>
                    <when test="searchType != null and searchType == 'noInitial'">
                        AND 초기상담일 = ''
                    </when>
                    <when test="searchType != null and searchType == 'recent21'">
                        AND DATEDIFF(DAY, 최근상담일, GETDATE()) <![CDATA[>=]]> 21
                        AND 최근상담일 <![CDATA[<>]]> ''
                    </when>
                    <when test="searchType != null and searchType == 'jobExpire'">
                        AND DATEDIFF(DAY, GETDATE(), 구직만료일) <![CDATA[<=]]> 15
                        AND 구직만료일 <![CDATA[<>]]> ''
                    </when>
                    <when test="searchType != null and searchType == 'periodExpire'">
                        AND DATEDIFF(DAY, GETDATE(), 기간만료일) <![CDATA[<=]]> 15
                        AND 기간만료일 <![CDATA[<>]]> ''
                        AND 최근상담일 <![CDATA[<>]]> ''
                    </when>
                    <when test="searchType != null and searchType == 'employment'">
                        AND 취창업일 <![CDATA[<>]]> ''
                    </when>
                </choose>
        ) AS SUB_QUERY
        WHERE SUB_QUERY.RowNum>#{startPage} AND #{endPage} >= SUB_QUERY.RowNum
    </select>

    <select id="selectCountParticipant" resultType="participant">
        SELECT
            COUNT(구직번호) totalCount
        FROM J_참여자관리
        WHERE
            전담자_계정 = #{participantUserid} AND
            지점 = #{participantBranch}
        <choose>
            <when test="participantRegDate != 'All' and participantRegDate != null">
                AND YEAR(등록일) = #{participantRegDate}
            </when>
        </choose>
        <choose>
            <when test="endDateOption == 'false'">
                AND (마감 = 'false' OR 마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND 마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND 초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, 최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), 구직만료일) <![CDATA[<=]]> 15
                AND 구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), 기간만료일) <![CDATA[<=]]> 15
                AND 기간만료일 <![CDATA[<>]]> ''
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND 취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>

    </select>
    <!-- 기본 쿼리 끝 -->

    <!-- 검색 쿼리 시작 -->
    <select id="selectAllParticipantSearch" resultType="participant">
        SELECT TOP (#{pageRows})
            구직번호 AS participantJobNo,
            참여자 AS participantPartic,
            성별 AS participantGender,
            최근상담일 AS participantLastCons,
            상담경과일 AS participantAdventCons,
            진행단계 AS participantProgress,
            생년월일 AS participantDob,
            등록일 AS participantRegDate,
            간접고용서비스 AS participantEmploymentService,
            마감 AS participantClose
        FROM (
                 SELECT
                        ROW_NUMBER() OVER (ORDER BY
                        <choose>
                            <!--구직번호가 아니라면-->
                            <when test="column == '구직번호' or column == '참여자' or column == '성별' or
                                                        column == '최근상담일' or column == '진행단계' or
                                                        column == '생년월일' or column == '등록일' or column == '간접고용서비스'">
                                ${column}
                            </when>
                            <when test="column == '상담경과일'">
                                DATEDIFF(DAY, 최근상담일, GETDATE())
                            </when>
                            <otherwise>
                                구직번호
                            </otherwise>
                        </choose>
                        <choose>
                            <when test="column != '' and order != '' and (order == 'asc' or order == 'desc')">
                                ${order}
                            </when>
                            <otherwise>
                                DESC
                            </otherwise>
                        </choose>
                        ) AS RowNum,
                     구직번호,
                     참여자,
                     성별,
                     CASE
                         WHEN 최근상담일 >= DATEADD(YEAR, -100, GETDATE()) THEN 최근상담일
                         END AS 최근상담일,
                     진행단계,
                     CASE
                         WHEN 생년월일 >= DATEADD(YEAR, -100, GETDATE()) THEN 생년월일
                         END AS 생년월일,
                     CASE
                         WHEN 등록일 >= DATEADD(YEAR, -100, GETDATE()) THEN 등록일
                         END AS 등록일,
                     CASE
                        WHEN 최근상담일 <![CDATA[<>]]> ''  AND 마감='false'
                        THEN DATEDIFF(DAY, 최근상담일, GETDATE())
                        END AS 상담경과일,
                     간접고용서비스,
                     마감
                 FROM J_참여자관리
                 WHERE
                    전담자_계정 = #{participantUserid} AND
                    지점 = #{participantBranch} AND
                    ${searchOption} like '%'+#{search}+'%'
                    <choose>
                        <when test="participantRegDate != 'All' and participantRegDate != null">
                            AND YEAR(등록일) = #{participantRegDate}
                        </when>
                    </choose>
                    <choose>
                        <when test="endDateOption == 'false'">
                            AND (마감 = 'false' OR 마감 = '')
                        </when>
                        <when test="endDateOption == 'true'">
                            AND 마감 = 'true'
                        </when>
                    </choose>
                    <choose>
                        <when test="searchType != null and searchType == 'noInitial'">
                            AND 초기상담일 = ''
                        </when>
                        <when test="searchType != null and searchType == 'recent21'">
                            AND DATEDIFF(DAY, 최근상담일, GETDATE()) <![CDATA[>=]]> 21
                            AND 최근상담일 <![CDATA[<>]]> ''
                        </when>
                        <when test="searchType != null and searchType == 'jobExpire'">
                            AND DATEDIFF(DAY, GETDATE(), 구직만료일) <![CDATA[<=]]> 15
                            AND 구직만료일 <![CDATA[<>]]> ''
                        </when>
                        <when test="searchType != null and searchType == 'periodExpire'">
                            AND DATEDIFF(DAY, GETDATE(), 기간만료일) <![CDATA[<=]]> 15
                            AND 기간만료일 <![CDATA[<>]]> ''
                            AND 최근상담일 <![CDATA[<>]]> ''
                        </when>
                        <when test="searchType != null and searchType == 'employment'">
                            AND 취창업일 <![CDATA[<>]]> ''
                        </when>
                    </choose>
             ) AS SUB_QUERY
        WHERE SUB_QUERY.RowNum>#{startPage} AND #{endPage} >= SUB_QUERY.RowNum
    </select>

    <select id="selectCountParticipantSearch" resultType="participant">
        SELECT
            COUNT(구직번호) totalCount
        FROM J_참여자관리
        WHERE
            전담자_계정 = #{participantUserid} AND
            지점 = #{participantBranch} AND
            ${searchOption} like '%'+#{search}+'%'
        <choose>
            <when test="participantRegDate != 'All' and participantRegDate != null">
                AND YEAR(등록일) = #{participantRegDate}
            </when>
        </choose>
        <choose>
            <when test="endDateOption == 'false'">
                AND (마감 = 'false' OR 마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND 마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND 초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, 최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), 구직만료일) <![CDATA[<=]]> 15
                AND 구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), 기간만료일) <![CDATA[<=]]> 15
                AND 기간만료일 <![CDATA[<>]]> ''
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND 취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>
    </select>
    <!-- 검색 쿼리 끝 -->

    <!-- 참여자 전체 자격증 확인용 쿼리 시작 -->
    <select id="selectOneParticcertif" resultType="participant">
        SELECT
            COUNT(구직번호) AS participantCount
        From
            J_참여자관리_자격증
        WHERE
            구직번호=#{participantJobNo}
    </select>
    <!-- 참여자 전체 자격증 확인용 쿼리 끝 -->

    <!-- 참여자 전체 직업훈련 확인용 쿼리 시작 -->
    <select id="selectOneEducation" resultType="participant">
        SELECT
            COUNT(구직번호) AS participantCount
        From
            J_참여자관리_직업훈련
        WHERE
            구직번호=#{participantJobNo}
    </select>
    <!-- 참여자 전체 직업훈련 확인용 쿼리 끝 -->

    <!-- 참여자 전체 상담 확인용 쿼리 시작 -->
    <select id="selectOneCounsel" resultType="participant">
        SELECT
            COUNT(구직번호) AS participantCount
        From
            J_참여자관리
        WHERE
            구직번호=#{participantJobNo}
    </select>
    <!-- 참여자 전체 상담 확인용 쿼리 끝 -->

    <!-- 외부 참여자 전달용 쿼리 시작 -->
    <select id="selectExternal" resultType="participant">
        SELECT
            구직번호 AS participantJobNo,
            참여자 AS participantPartic,
            성별 AS participantGender,
            주소 AS participantAddress,
            학교명 AS participantSchool,
            전공 AS participantSpecialty,
            희망직무 AS participantJobWant,
            자격증 AS certificationName,
            희망연봉 AS participantSalWant,
            상담사 AS participantUserName,
            이메일 AS participantEmail,
            전화번호 AS participantPhoneNumber,
            고유번호 AS participantCode
        FROM (
                 SELECT
                     ROW_NUMBER() OVER (ORDER BY 구직번호 DESC) AS RowNum,
                     구직번호,
                     참여자,
                     성별,
                     주소,
                     학교명,
                     전공,
                     희망직무,
                     자격증,
                     희망연봉,
                     상담사,
                     이메일,
                     전화번호,
                     고유번호
                 FROM
                     EXTERNALPARTICIPANT ) AS SUB_QUERY
        WHERE
            SUB_QUERY.RowNum>#{startPage} AND #{endPage} >= SUB_QUERY.RowNum;
    </select>

    <select id="selectExternalCount" resultType="participant">
        SELECT
            COUNT(구직번호) AS totalCount
        FROM
            EXTERNALPARTICIPANT;
    </select>
    <!-- 외부 참여자 전달용 쿼리 끝 -->

    <!-- 삭제 쿼리 시작 -->
    <!-- 기본 정보 삭제 쿼리 -->
    <delete id="participantDelete">
        DELETE FROM J_참여자관리 WHERE 구직번호 = #{participantJobNo} AND 전담자_계정 = #{participantUserid}
    </delete>
    <!-- 자격증 정보 삭제 쿼리 -->
    <delete id="participantParticcertifDelete">
        DELETE FROM J_참여자관리_자격증 WHERE 구직번호 = #{participantJobNo}
    </delete>
    <!-- 자격증 정보 삭제 쿼리 -->
    <delete id="participantEducationDelete">
        DELETE FROM J_참여자관리_직업훈련 WHERE 구직번호 = #{participantJobNo}
    </delete>
    <!-- 삭제 쿼리 끝 -->

    <!-- 참여자 전체 데이터 엑셀 다운 쿼리 시작 -->
    <select id="participantExcel" resultType="participant">
        SELECT
            ISNULL(구직번호, '') AS participantJobNo,
            ISNULL(A.등록일, '') AS participantRegDate,
            ISNULL(이름, '') AS participantUserName,
            ISNULL(참여자, '') AS participantPartic,
            ISNULL(생년월일, '') AS participantDob,
            ISNULL(성별, '') AS participantGender,
            ISNULL(모집경로, '') AS participantRecruit,
            ISNULL(참여유형, '') AS participantPartType,
            ISNULL(학교명, '') AS participantSchool,
            ISNULL(전공, '') AS participantSpecialty,
            ISNULL(주소, '') AS participantAddress,
            ISNULL(경력, '') AS participantAntecedents,
            ISNULL(특정계층, '') AS participantSpecific,
            ISNULL(알선요청, '') AS participantPlacement,
            ISNULL(취업역량, '') AS participantJobSkill,
            ISNULL(최근상담일, '') AS participantLastCons,
            ISNULL(진행단계, '') AS participantProgress,
            ISNULL(초기상담일, '') AS participantInItCons,
            ISNULL(구직만료일, '') AS participantJobEX,
            ISNULL(IAP수료일, '') AS participantIAPDate,
            ISNULL([3단계진입일], '') AS participantStepPro,
            ISNULL(기간만료일, '') AS participantEXPDate,
            ISNULL(희망직무, '') AS participantJobWant,
            ISNULL(
                    CASE
                        WHEN ISNUMERIC(희망급여) = 1 THEN 희망급여
                        ELSE '0'
                        END, '0'
            ) AS participantSalWant,
            ISNULL(취창업일, '') AS participantStartDate,
            ISNULL(취창업처리일, '') AS participantProcDate,
            ISNULL(취업유형, '') AS participantEmpType,
            ISNULL(취업처, '') AS participantLoyer,
            ISNULL(
                    CASE
                        WHEN ISNUMERIC(임금) = 1 THEN 임금
                        ELSE '0'
                        END, '0'
            ) AS participantSalary,
            ISNULL(직무, '') AS participantJobRole,
            ISNULL(취업인센티브_구분, '') AS participantIncentive,
            ISNULL(일경험분류, '') AS participantJobcat,
            ISNULL(메모, '') AS participantMemo,
            ISNULL(기타, '') AS participantOthers,
            ISNULL(마감, '') AS participantClose,
            ISNULL(퇴사일, '') AS participantQuit,
            ISNULL(A.지점, '') AS participantBranch,
            ISNULL(중단종료일, '') AS participantEndDate,
            ISNULL(간접고용서비스, '') AS participantEmploymentService
        FROM J_참여자관리 A
                 LEFT JOIN J_참여자관리_로그인정보 B
                           ON A.전담자_계정 = B.아이디
        WHERE B.아이디 = #{participantUserid} and B.지점 = #{participantBranch};
    </select>
    <!-- 참여자 전체 데이터 엑셀 다운 쿼리 끝 -->



    <!-- 지점관리 기본 쿼리 시작 -->
    <select id="selectAllParticipantBranch" resultType="participant">
        SELECT TOP (#{pageRows})
        구직번호 AS participantJobNo,
        이름 AS participantUserName,
        참여자 AS participantPartic,
        성별 AS participantGender,
        최근상담일 AS participantLastCons,
        상담경과일 AS participantAdventCons,
        진행단계 AS participantProgress,
        생년월일 AS participantDob,
        등록일 AS participantRegDate,
        간접고용서비스 AS participantEmploymentService,
        마감 AS participantClose
        FROM (
        SELECT
        ROW_NUMBER() OVER (ORDER BY
        <choose>
            <!--구직번호가 아니라면-->
            <when test="column == '구직번호' or column == '참여자' or column == '성별' or
                                        column == '최근상담일' or column == '진행단계' or
                                        column == '생년월일' or column == '등록일' or column == '간접고용서비스'">
                A.${column}
            </when>
            <when test="column == '전담자'">
                B.이름
            </when>
            <when test="column == '상담경과일'">
                DATEDIFF(DAY, A.최근상담일, GETDATE())
            </when>
            <otherwise>
                A.구직번호
            </otherwise>
        </choose>
        <choose>
            <when test="column != '' and order != '' and (order == 'asc' or order == 'desc')">
                ${order}
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
        ) AS RowNum,
        A.구직번호,
        B.이름,
        A.참여자,
        A.성별,
        CASE
        WHEN A.최근상담일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.최근상담일
        END AS 최근상담일,
        A.진행단계,
        CASE
        WHEN A.생년월일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.생년월일
        END AS 생년월일,
        CASE
        WHEN A.등록일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.등록일
        END AS 등록일,
        CASE
        WHEN A.최근상담일 <![CDATA[<>]]> ''  AND A.마감='false'
        THEN DATEDIFF(DAY, A.최근상담일, GETDATE())
        END AS 상담경과일,
        A.간접고용서비스,
        A.마감
        FROM J_참여자관리 A
        JOIN J_참여자관리_로그인정보 B
        ON A.전담자_계정 = B.아이디
        WHERE
        A.지점 = #{participantBranch}
        <choose>
            <when test="participantRegDate != 'All' and participantRegDate != null">
                AND YEAR(A.등록일) = #{participantRegDate}
            </when>
        </choose>
        <choose>
            <when test="endDateOption == 'false'">
                AND (A.마감 = 'false' OR A.마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND A.마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND A.초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, A.최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.구직만료일) <![CDATA[<=]]> 15
                AND A.구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.기간만료일) <![CDATA[<=]]> 15
                AND A.기간만료일 <![CDATA[<>]]> ''
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND A.취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>
        ) AS SUB_QUERY
        WHERE SUB_QUERY.RowNum>#{startPage} AND #{endPage} >= SUB_QUERY.RowNum
    </select>

    <select id="selectCountParticipantBranch" resultType="participant">
        SELECT
        COUNT(구직번호) totalCount
        FROM J_참여자관리
        WHERE
        지점 = #{participantBranch}
        <choose>
            <when test="endDateOption == 'false'">
                AND (마감 = 'false' OR 마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND 마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND 초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, 최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), 구직만료일) <![CDATA[<=]]> 15
                AND 구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), 기간만료일) <![CDATA[<=]]> 15
                AND 기간만료일 <![CDATA[<>]]> ''
                AND 최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND 취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>

    </select>
    <!-- 지점관리 기본 쿼리 끝 -->

    <!-- 지점관리 검색 쿼리 시작 -->
    <select id="selectAllParticipantSearchBranch" resultType="participant">
        SELECT TOP (#{pageRows})
        구직번호 AS participantJobNo,
        이름 AS participantUserName,
        참여자 AS participantPartic,
        성별 AS participantGender,
        최근상담일 AS participantLastCons,
        상담경과일 AS participantAdventCons,
        진행단계 AS participantProgress,
        생년월일 AS participantDob,
        등록일 AS participantRegDate,
        간접고용서비스 AS participantEmploymentService,
        마감 AS participantClose
        FROM (
        SELECT
        ROW_NUMBER() OVER (ORDER BY
        <choose>
            <!--구직번호가 아니라면-->
            <when test="column == '구직번호' or column == '참여자' or column == '성별' or
                                        column == '최근상담일' or column == '진행단계' or
                                        column == '생년월일' or column == '등록일' or column == '간접고용서비스'">
                A.${column}
            </when>
            <when test="column == '전담자'">
                B.이름
            </when>
            <when test="column == '상담경과일'">
                DATEDIFF(DAY, A.최근상담일, GETDATE())
            </when>
            <otherwise>
                A.구직번호
            </otherwise>
        </choose>
        <choose>
            <when test="column != '' and order != '' and (order == 'asc' or order == 'desc')">
                ${order}
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
        ) AS RowNum,
        A.구직번호,
        B.이름,
        A.참여자,
        A.성별,
        CASE
        WHEN A.최근상담일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.최근상담일
        END AS 최근상담일,
        A.진행단계,
        CASE
        WHEN A.생년월일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.생년월일
        END AS 생년월일,
        CASE
        WHEN A.등록일 >= DATEADD(YEAR, -100, GETDATE()) THEN A.등록일
        END AS 등록일,
        CASE
        WHEN A.최근상담일 <![CDATA[<>]]> ''  AND A.마감='false'
        THEN DATEDIFF(DAY, A.최근상담일, GETDATE())
        END AS 상담경과일,
        A.간접고용서비스,
        A.마감
        FROM J_참여자관리 A
        JOIN J_참여자관리_로그인정보 B
        ON A.전담자_계정 = B.아이디
        WHERE
        A.지점 = #{participantBranch} AND
        <choose>
            <when test="searchOption='전담자'">
                B.이름 like '%'+#{search}+'%'
            </when>
            <otherwise>
                A.${searchOption} like '%'+#{search}+'%'
            </otherwise>
        </choose>
        <choose>
            <when test="endDateOption == 'false'">
                AND (A.마감 = 'false' OR A.마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND A.마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND A.초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, A.최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.구직만료일) <![CDATA[<=]]> 15
                AND A.구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.기간만료일) <![CDATA[<=]]> 15
                AND A.기간만료일 <![CDATA[<>]]> ''
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND A.취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>
        ) AS SUB_QUERY
        WHERE SUB_QUERY.RowNum>#{startPage} AND #{endPage} >= SUB_QUERY.RowNum
    </select>

    <select id="selectCountParticipantSearchBranch" resultType="participant">
        SELECT
        COUNT(구직번호) totalCount
        FROM J_참여자관리 A
        JOIN J_참여자관리_로그인정보 B
        ON A.전담자_계정 = B.아이디
        WHERE
        A.지점 = #{participantBranch} AND
        <choose>
            <when test="searchOption='전담자'">
                B.이름 like '%'+#{search}+'%'
            </when>
            <otherwise>
                A.${searchOption} like '%'+#{search}+'%'
            </otherwise>
        </choose>
        <choose>
            <when test="endDateOption == 'false'">
                AND (A.마감 = 'false' OR A.마감 = '')
            </when>
            <when test="endDateOption == 'true'">
                AND A.마감 = 'true'
            </when>
        </choose>
        <choose>
            <when test="searchType != null and searchType == 'noInitial'">
                AND A.초기상담일 = ''
            </when>
            <when test="searchType != null and searchType == 'recent21'">
                AND DATEDIFF(DAY, A.최근상담일, GETDATE()) <![CDATA[>=]]> 21
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'jobExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.구직만료일) <![CDATA[<=]]> 15
                AND A.구직만료일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'periodExpire'">
                AND DATEDIFF(DAY, GETDATE(), A.기간만료일) <![CDATA[<=]]> 15
                AND A.기간만료일 <![CDATA[<>]]> ''
                AND A.최근상담일 <![CDATA[<>]]> ''
            </when>
            <when test="searchType != null and searchType == 'employment'">
                AND A.취창업일 <![CDATA[<>]]> ''
            </when>
        </choose>
    </select>
    <!-- 지점관리 검색 쿼리 끝 -->



    <!-- 참여자 전체 데이터 엑셀 다운 쿼리 시작 -->
    <select id="participantBranchExcel" resultType="participant">
        SELECT
            ISNULL(구직번호, '') AS participantJobNo,
            ISNULL(A.등록일, '') AS participantRegDate,
            ISNULL(이름, '') AS participantUserName,
            ISNULL(참여자, '') AS participantPartic,
            ISNULL(생년월일, '') AS participantDob,
            ISNULL(성별, '') AS participantGender,
            ISNULL(모집경로, '') AS participantRecruit,
            ISNULL(참여유형, '') AS participantPartType,
            ISNULL(학교명, '') AS participantSchool,
            ISNULL(전공, '') AS participantSpecialty,
            ISNULL(주소, '') AS participantAddress,
            ISNULL(경력, '') AS participantAntecedents,
            ISNULL(특정계층, '') AS participantSpecific,
            ISNULL(알선요청, '') AS participantPlacement,
            ISNULL(취업역량, '') AS participantJobSkill,
            ISNULL(최근상담일, '') AS participantLastCons,
            ISNULL(진행단계, '') AS participantProgress,
            ISNULL(초기상담일, '') AS participantInItCons,
            ISNULL(구직만료일, '') AS participantJobEX,
            ISNULL(IAP수료일, '') AS participantIAPDate,
            ISNULL([3단계진입일], '') AS participantStepPro,
            ISNULL(기간만료일, '') AS participantEXPDate,
            ISNULL(희망직무, '') AS participantJobWant,
            ISNULL(
                    CASE
                        WHEN ISNUMERIC(희망급여) = 1 THEN 희망급여
                        ELSE '0'
                        END, '0'
            ) AS participantSalWant,
            ISNULL(취창업일, '') AS participantStartDate,
            ISNULL(취창업처리일, '') AS participantProcDate,
            ISNULL(취업유형, '') AS participantEmpType,
            ISNULL(취업처, '') AS participantLoyer,
            ISNULL(
                    CASE
                        WHEN ISNUMERIC(임금) = 1 THEN 임금
                        ELSE '0'
                        END, '0'
            ) AS participantSalary,
            ISNULL(직무, '') AS participantJobRole,
            ISNULL(취업인센티브_구분, '') AS participantIncentive,
            ISNULL(일경험분류, '') AS participantJobcat,
            ISNULL(메모, '') AS participantMemo,
            ISNULL(기타, '') AS participantOthers,
            ISNULL(마감, '') AS participantClose,
            ISNULL(퇴사일, '') AS participantQuit,
            ISNULL(A.지점, '') AS participantBranch,
            ISNULL(중단종료일, '') AS participantEndDate,
            ISNULL(간접고용서비스, '') AS participantEmploymentService
        FROM J_참여자관리 A
                 LEFT JOIN J_참여자관리_로그인정보 B
                           ON A.전담자_계정 = B.아이디
        WHERE B.지점 = #{participantBranch};
    </select>
    <!-- 참여자 전체 데이터 엑셀 다운 쿼리 끝 -->

    <!-- 데이터 이전 쿼리 시작 -->
    <select id="transferSelect" resultType="participant">
        SELECT
            ISNULL(구직번호, '') AS participantJobNo,
            ISNULL(A.등록일, '') AS participantRegDate,
            ISNULL(이름, '') AS participantUserName,
            ISNULL(참여자, '') AS participantPartic,
            CASE WHEN 생년월일 >= DATEADD(YEAR, -100, GETDATE()) THEN 생년월일 END AS participantDob,
            ISNULL(성별, '') AS participantGender,
            ISNULL(참여유형, '') AS participantPartType
        FROM J_참여자관리 A
                 LEFT JOIN J_참여자관리_로그인정보 B
                           ON A.전담자_계정 = B.아이디
        WHERE B.아이디 = #{participantUserid} and B.지점 = #{participantBranch}
        <if test="participantIDs != null and participantIDs.size() > 0 and participantIDs[0] != null">
            AND 구직번호 IN
            <foreach collection="participantIDs" item="data" open="(" separator="," close=")">
                #{data}
            </foreach>
        </if>
    </select>
    <!-- 참여자 전체 데이터 엑셀 다운 쿼리 끝 -->

    <update id="transferUpdate">
        UPDATE J_참여자관리
        SET 전담자_계정 = #{targetCounselorID},
        메모 = CONCAT(메모, ',', CONVERT(nvarchar, GETDATE()), ' ', #{sourceCounselorID}, ' 테스트 상담사 데이터 이관')
        WHERE 전담자_계정 = #{sourceCounselorID}
        AND 지점 = #{participantBranch}
        AND 구직번호 IN
        <foreach collection="participantIDs" item="data" open="(" separator="," close=")">
            #{data}
        </foreach>
    </update>


</mapper>